<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="theme-color" content="#444" />
        <link href="css/style.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
        <script src="https://kit.fontawesome.com/eb0c496755.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        

        <link rel="stylesheet" href="css/addtohomescreen.css">
        <script src="src/addtohomescreen.min.js"></script>
        <script src="src/requester.js"></script>
        <script src="src/notification.js"></script>

        <link rel="apple-touch-icon" sizes="512x512" href="img/icon.png">
        <meta name="apple-mobile-web-app-title" content="Music Player">
        <link rel="icon" sizes="128x128" href="img/icon-128.png">
        <link rel="icon" sizes="512x512" href="img/icon-512.png">
        <link rel="icon" type="image/x-icon" href="img/favicon.ico">
        <link rel="manifest" href="manifest.json">
        <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
        <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
        <script src="https://cdn.plyr.io/3.7.2/plyr.polyfilled.js"></script>
        <script src="src/crossPlatform.js"></script>
        <script src="src/itemGenerator.js"></script>
        <script src="src/dataSaver.js"></script>
        <script src="src/music-base64.js"></script>
        <script src="src/utils.js"></script>
        <script src="src/settings.js"></script>
        <script src="src/auth.js"></script>
        <script src="src/store.js"></script>

        <!-- debugging -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/eruda/2.5.0/eruda.min.js"></script>

    </head>
    <body style="background-color: black; padding-top:30px;" class="body">
        <div class="alert alert-primary d-none" role="alert">
            This is a primary alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.
          </div>

        <div id="main-play-container" class="d-none container main-page" style="background-color:#333; padding-top: 5px; border-radius: 20px;">
            <div class="row main-play-horizontal-btn">
                
                <div class="d-flex justify-content-center">
                <div style="height: 4px; width:36px; border-radius: 2px; background-color: #bbb;" id="main-play-top-line"></div>
                    </div>
            </div>
            <div class="main-play-horizontal-btn" style="height: 20px;"></div>
            <div class="row">
                <div class="col player-panel" id="musicPlayerCol">
                    <div class="d-flex justify-content-center">
                    <img src="album-cover.jpg" class="img-fluid song-cover" id="main-song-cover" style="max-height: 360px; object-fit: cover; box-shadow: 2px 2px 20px #000;" alt="...">
                    <div id="main-song-cover2" style="background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0,0,0,0.8)), url('album-cover.jpg'); background-size: cover;" class="d-none img-fluid d-flex flex-column flex-nowrap overflow-auto" style="max-height: 360px; object-fit: cover; box-shadow: 2px 2px 20px #000;">
                        <div class="text-center" style="margin-top: 10px; margin-bottom: 10px; text-shadow: 2px 2px 8px #dddddd; color: white; filter: brightness(300%)" id="song-desc">    
                            This is the description<br>
                            
                        </div>
                        
                    </div>

                </div>
                </div>


            </div>

            <div class="row" style="margin-top: 15px;">
                <div class="d-flex align-items-center">
                <div class="col" id="main-player-title-scroll-row">
                    <div class="d-flex justify-content-start"> <marquee width="300" direction="left" style="color: white;" class="h5 song-name">Title</marquee> </div>
                </div>

                <div class="col-2">
                    <div class="d-flex justify-content-end" style="color: #888;">
                        <i class="fa-regular fa-heart heart-btn" style="margin-right: 16px;"></i>
                    </div>
                </div>
            </div>
            </div>
            <div class="row" style="margin-top: -5px;">
                <div class="d-flex justify-content-start">
                    <div class="text-muted artist-name" style="font-size: 12px;">Singer</div>
                </div>
            </div>
            <div id="debugInfo" style="color:red"></div>

            <div class="row" style="margin-left: 0px; margin-right: 0px; margin-top: 24px;">
                <div class="progress" style="height: 4px; border-radius: 6px; background-color: grey; padding-left: 0px; padding-right: 0px;">
                    <div id="main-progress-bar" class="progress-bar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 30%; background-color: #b7b7b7;"></div>
                </div>
            </div>

            <div class="row progress-bar" style="margin-top: -4px;">
                <div class="audio-player">
                    <div id="seekObjContainer">
                        <div id="timeline1">
                            <div id="seekObj1" class="playhead" style="margin-left: 0px;"></div>
                        </div>
                    </div>
                    <div class="audio-wrapper">
                        <audio id="player2" preload="none">
                              <!-- <source id="player-source" src="http://d2cstorage-a.akamaihd.net/wbr/gotnext/8578.mp3" type="audio/mp3"> -->
                              <source id="player-source" type="audio/mp4">

                        </audio>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-start">
                    <div style="font-size: 12px;" class="start-time text-muted"></div></div>
                </div>

                <div class="col">
                    <div class="d-flex justify-content-end">
                    <div style="font-size: 12px;" class="end-time text-muted"></div></div>
                </div>
            </div>

            <div class="row" style="margin-top: 24px; color:white;">
                <div class="d-flex align-items-center">
                <div class="col" id="main-player-download-btn">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-cloud-arrow-down"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-backward-step" id="prev-song-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-circle-play fa-2xl main-play-btn" id="major-play-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-forward-step" id="next-song-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-list" style="color:#888"></i></div></div>
                    </div>
            </div>

            <!-- <div class="play-pause">play</div> -->

            


            <div class="container" style="height: 20px;">

            </div>

        </div>

        <div id="main-home-container" class="d-none container main-page" style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row">
                <picture>
                    <img src="img/icon-128.png" class="img-fluid" style="height: 64px;" alt="...">
                  </picture></div>

            <div class="row" style="margin-top: 20px; margin-left: 0px;">
                <h5>Listen again</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 250px;">
                <div class="card mx-2" style="height:200px; min-width: 200px; max-width: 200px; background-color: black;">
                    <img  src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" >
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: white; font-size: 12px;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>
                  
                  <div class="card mx-2" style="width: 10rem;min-width: 200px; max-width: 200px; background-color: black;">
                    <img src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" alt="...">
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: black;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>  

                  <div class="card mx-2" style="width: 10rem; min-width: 200px; max-width: 200px; background-color: black;">
                    <img src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" alt="...">
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: black;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>  
            </div>

            

            </div>

            <div class="row" style="margin-top: 20px; margin-left: 0px;">
                <h5>Quick picks</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 180px;">
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div> 
                <div class="card card-block mx-2" style="min-width: 200px; ">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>           
            </div>
            </div>

            <div class="row" style="margin-top: 60px; margin-left: 0px;">
                <h5>Popular songs</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 120px;">
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div> 
                <div class="card card-block mx-2" style="min-width: 200px; ">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>           
            </div>
            </div>

            <form>
                <div class="form-group">
                  <label for="exampleFormControlFile1">Example file input</label>
                  <input type="file" class="form-control-file" id="exampleFormControlFile1" multiple>
                </div>
              </form>


            <div class="container" style="margin-top: 200px;">

            </div>

        </div>

        <div class="main-page d-none" id="playlist-combined-container">
        <div id="main-playlist-container" class="container  d-none" style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row">
                <div class="col d-flex justify-content-left">
                    <i class="fa-solid fa-headphones fa-xl" style="padding-top: 12px;padding-left: 12px;"></i>
                    <h4 style="margin-left: 6px;">My Playlists</h4>
                    </div>
            </div>

            <div class="row" style="margin-top: 32px;">
                <div style="height:100%; width:100%; overflow:hidden; overflow-y:scroll;">
                    <div class="playlist-item" style="margin-bottom: 12px;">
                        <div class="row">
                            <div class="col-8">
                                <div class="d-flex justify-content-left" id="liked-songs-item">
                                <img style="border-radius: 12%; height: 45px; width: 45px; object-fit:cover; padding: 0px; margin-left: 12px;" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR2jKX0ATfz8woidgFJ-1SttFBzHyKZUJfO5Q&usqp=CAU">
                                <div class="col" style="margin-left: 12px;">
                                    <h6 style="color: white;margin-bottom: 0px;">Liked Songs</h6>
                                    <div style="color: #999; font-size: 16px;" id="numberOfLikedSongs">10 songs available</div>
                                </div>
                            </div>
                            </div>

                            <div class="col">
                                    <div class="d-flex justify-content-end">
                                        <i class="fa-solid fa-ellipsis-vertical" style="margin-top:12px; margin-right:12px;"></i>
                                    </div>

                                
                            </div>

                            
                            
                        </div>


                    </div>
                    
                    
    
                </div>
            </div>
            <div style="margin-top: 40px;"></div>

        </div>

        <div id="playlist-items-container" class="container " style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row" >
                <div class="col d-flex justify-content-left align-items-center"  id="return-to-playlist-btn">
                    <i class="fa-solid fa-angle-left fa-xl" style="padding-left: 12px;"></i>
                    <h2 style="margin-left: 12px;">Liked Songs</h2>
                    </div>

                    <div class="col-1 d-flex justify-content-end" id="sync-playlist-btn">
                        <i class="fa-solid fa-arrows-rotate" style="margin-right: 16px;margin-top: 12px;"></i>
                    </div>

                    <div class="col-1 d-flex justify-content-end" id="add-to-playlist-btn">
                        <i class="fa-solid fa-plus" style="margin-right: 16px;margin-top: 12px;"></i>
                    </div>
            </div>

            <div class="row" style="margin-top: 24px;">
                <div class="col d-flex justify-content-center" id="playlist-playall-btn" style="padding-top: 6px;padding-bottom: 6px;">
                    <b>Play All</b>
                </div>
                <div class="col d-flex justify-content-center" style="padding-top: 6px;padding-bottom: 6p">
                    <b style="color: gray;">Shuffled Play</b>
                </div>
            </div>

            <div class="row" style="margin-top: 32px;">
                <div style="height:100%; width:100%; overflow:hidden; overflow-y:scroll; min-height: 600px;" id="playlist-songitem-list">
                    <!-- <div class="text-center" style="color: white">List is empty.</div> -->


                    



                </div>
            </div>
            <div style="margin-top: 150px;"></div>

        </div>
    </div>

    <div class="main-page container" id="search-container" style="color: white;">
        <div class="row">
            <div class="col d-flex justify-content-left">
                <i class="fa-solid fa-magnifying-glass fa-xl" style="padding-top: 12px;padding-left: 12px;"></i>
                <h4 style="margin-left: 6px;">Search</h4>
                </div>
        </div>
        <div class="row">
        <div class="input-group mb-3">
            <input type="text" id="search-input" class="form-control" style="background-color: #333; color:#fff" placeholder="what you want to listen today?" aria-label="keywords">
            <button class="btn btn-secondary" type="button" id="search-song-btn">Search</button>
          </div>
        </div>

        <div class="row d-flex align-items-center justify-content-center d-none" style="height: 300px;" id="loading-indicator">
            <div class="spinner-border text-secondary" role="status">
          <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="row" style="margin-top: 32px;" id="search-results">
            <div style="height:100%; width:100%; overflow:hidden; overflow-y:scroll; min-height: 600px;" id="search-songitem-list">

            </div>
        </div>

        <div class="row d-flex justify-content-center d-none" style="margin-top: 32px;" id="load-more-container">
            <div class="d-flex justify-content-center"><strong id="load-more-search-btn">Load More</strong></div>
        </div>
        <div style="margin-top: 150px;"></div>

    </div>

    <div class="main-page container d-none" id="user-center-container">
        <div class="row">
            <div class="col d-flex justify-content-center" style="padding-left: 0px;padding-right: 0px;">
                <img id="user-photo-settings" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQd_A1KWEAF8xoaZLlOT1PbmJv2H-46t7witrnmDyA&s" class="img-thumbnail" alt="..." style="border-radius: 50%;">
            </div>


        </div>
        <div class="row" style="color: white; font-size: 32px;">
            <div class="d-flex justify-content-center" id="user-name-settings">
            Guest
        </div>
    </div>

    <div class="row" style="color: gray; font-size: 16px;">
        <div class="d-flex justify-content-center" id="user-email-settings">
        
        </div>
    </div>

    <div class="row" style="color: white; font-size: 16px; margin-top: 16px;">
        <div class="d-flex justify-content-center">
        <strong id="user-login-google">Login with Google</strong>
        </div>
    </div>

    <div class="row" style="margin-top: 32px;">
        <div style="height:100%; width:100%; " id="user-center-list">
            <!-- setting items here -->
        </div>
    </div>
    <div style="margin-top: 100px;"></div>

    </div>

        <div class="container fixed-bottom text-center">
            <div id="float-player" class="">
                <div class="row" style="background-color: #444;">
                    <div class="col-8" id="float-player-left">
                        <div class="d-flex justify-content-left" style="margin-bottom: 6px; margin-top: 6px;">
                        <img style="height: 45px; width: 45px" class="song-cover" src="https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/best-rap-songs-1583527287.png">
                        <div class="col">
                            <div style="margin-left: 10px;">    
                        <small style="color: white;" class="d-flex justify-content-left"><marquee width="200" direction="left" style="color: white;" class="song-name">Title</marquee></small>
                        <small style="color: #999; font-size: smaller;" class="d-flex justify-content-left artist-name">Artist name</small>
                    </div>
                    </div>
                    </div>

                    
                    </div>

                    <div class="col">
                        <div class="d-flex justify-content-end" style="margin-bottom: 6px; margin-top: 6px;">
                            <div style="color: white; margin-top: 10px;" ><i class="fa-solid fa-play fa-xl main-play-btn" id="mini-play-btn"></i></div>
                            <div style="color: #888; margin-top: 10px; margin-left: 30px;" ><i class="fa-regular fa-heart fa-xl heart-btn"></i></div>
                        </div>
                    </div>
                </div>

                <div class="row" style="background-color:black;">
                    <div class="progress" style="height: 2px; border-radius: 0px; background-color: black; margin-left: 0px; padding-left: 0px;padding-right: 0px;">
                        <div id="mini-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            



            <div class="row" style="background-color:#333; border-radius: 0px; color: #888; ">
                <div class="col bottom-nav-btn" id="home-nav-btn" style="padding-top: 8px;">
                    <i class="fa fa-home"></i><p class="nav-btn-text">Home</p>
                </div>

                <div class="col bottom-nav-btn" id="playlist-nav-btn" style="color: white; padding-top: 8px;">
                    <i class="fa fa-music"></i><p class="nav-btn-text">Playlist</p>
                </div>

                <div class="col bottom-nav-btn" id="search-nav-btn" style="padding-top: 8px;">
                    <i class="fa-solid fa-magnifying-glass"></i><p class="nav-btn-text">Search</p>
                </div>

                <div class="col bottom-nav-btn" id="user-nav-btn" style="padding-top: 8px;">
                    <i class="fa fa-user"></i><p class="nav-btn-text">User</p>
                </div>
            </div>
        </div>


        <!-- modals -->

        <div class="modal fade" id="add-to-playlist-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add New Song</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exampleFormControlInput1" class="form-label">YouTube Link</label>
                        <input class="form-control" id="url-add-input" placeholder="https://www.youtube.com/watch?v=****">
                        <small id="error-in-adding-link" style="color: red" class="d-none">Not a valid YouTube video link.</small>
                      </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-secondary" id="add-url-and-play-btn">Add and Play</button>
                  <button type="button" class="btn btn-primary" id="comfirm-add-url-btn">Add</button>
                </div>
              </div>
            </div>
          </div>

        
          <!-- ios enter modal -->

          <div class="modal fade" id="ios-enter-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <!-- <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Compatibility Mode</h5>
                  <button type="button" class="btn-close" aria-label="Close" id="enter-modal-close-btn"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <small >Welcome. Compatibility mode is on iOS devices.</small>
                      </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="screen-enter-btn">Enter</button>
                </div>
              </div> -->
            </div>
          </div>


        <!-- <div style="width: 100%; height: 100vh; background-color: #0000008a; position:absolute; top:0px; right: 0px;"></div> -->

        </div>

    
        <script>
            var player1,onplayhead,playerId,timeline,playhead,timelineWidth,isPlaying;


let playURLs = {'urls': [
    // 'https://www.youtube.com/watch?v=Dzea8kRsFCI',
    // 'https://www.youtube.com/watch?v=dYAQU8qh0i4',
    // 'https://www.youtube.com/watch?v=944qO4mPdaY',
    // 'https://www.youtube.com/watch?v=qFNmFLEBAl8',
    // 'https://www.youtube.com/watch?v=myGNlPiTW5E',
    // 'https://www.youtube.com/watch?v=a-9pSJCnUeE',
    // 'https://www.youtube.com/watch?v=KaokgDEOKoI',
    // 'https://www.youtube.com/watch?v=TcpDNqkxMHY',
    // 'https://www.youtube.com/watch?v=istlCXqPfdM',
    'https://www.youtube.com/watch?v=uwGEWDJc2A8',

]};


let playlistData = [
    {'name': 'SoundHelix Song 1', 'artist': 'T. Schürger 1', 'image': 'https://i.ytimg.com/vi/Y0pdQU87dc8/sddefault.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', 'desc': 'Desc 1'},
    {'name': 'SoundHelix Song 2', 'artist': 'T. Schürger 2', 'image': 'https://media.timeout.com/images/105805144/750/422/image.jpg', 'url':'https://youtubemusic.songlinhou.repl.co/music_conv_url?url=https://www.youtube.com/watch?v=qFNmFLEBAl8', 'desc': 'Desc 2'},
    {'name': 'SoundHelix Song 3', 'artist': 'T. Schürger 3', 'image': 'https://www.adorama.com/alc/wp-content/uploads/2018/12/shutterstock_729861919.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', 'desc': 'Desc 3'},
    {'name': 'SoundHelix Song 4', 'artist': 'T. Schürger 4', 'image': 'https://www.musictoyourhome.com/wp-content/uploads/2021/04/8-Easy-Guitar-Songs-For-Every-Beginner.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', 'desc': 'Desc 4'},
    {'name': 'SoundHelix Song 5', 'artist': 'T. Schürger 5', 'image': 'https://www.musictoyourhome.com/wp-content/uploads/2022/02/Intermediate-Playing-Classical-Piano-Song.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', 'desc': 'Desc 5'},
]; // must sync with playURLs

let viewingPlaylistData = []; // user can browse play list without changing current one.

let currentIdxInPlayList = -1;
let lastIdxInPlayList = -1;
// let currentViewingPageId = "main-home-container";
let currentViewingPageId = "playlist-combined-container";
let height;
let current_song_length = -1;
let isLoadingNow = false;

// settings
let loopPlayList = true;
let showInAppDebug = false;


let onIOS = false;
let disableSongClickPlay = true;
let useMusicBase64 = false;
let preventAutoPlayNextSong = false;
let currentSongFinished = false;
let playerInit = false;
let currentPlayingSongCode = null;
let currentLikedSongCodes = null;

const performanceStats = {};



var preventDefault = function(e) {
    e.preventDefault();
    return false;
};

function doPlayerInitOnClick(){
    if(!playerInit){
        if(useMusicBase64){
            $("#player2").attr("src", "data:audio/mp4;base64," + noticeSound);
            $("#player2")[0].load();
            $("#player2")[0].play();
            logDebug("player init finished. (iOS requirements)");
        }
        else{
            logDebug("player init not needed for non-base64 mode.");
        }
    }
    playerInit = true;
}

function shuffleList(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle.
  while (currentIndex != 0) {

    // Pick a remaining element.
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

function generateSongHTMLInPlaylist(playlistData){
    let html = "";
    for(let i=0; i < playlistData.length; i++){
        const rec = playlistData[i];
        html += getSongItemHTML(i, rec.name, rec.artist, rec.image, rec.code);
    }
    $("#playlist-songitem-list").html(html);
}



$(window).on("load", async function () {
    onIOS = isOnIOS();
    if(onIOS){
        useMusicBase64 = true;
        console.log("iOS detected. Using high-compatibility mode");
    }
    else{
        useMusicBase64 = false;
        console.log("not on iOS. Using high-performance mode");
    }
    // alert("Is IOS? " + onIOS);
    initDatabase(); // set up database

    console.log("test id=", 1);
    setupBottomNav();
    $("#main-play-container").fadeIn("slow");
    audioPlay();
    ballSeek();
    height = screen.height;
    console.log("screen height=", height);
    // iosLimitationUI();
    // Hide the address bar!
    setTimeout(function(){
        window.scrollTo(0, 1);
  }, 0);
    document.addEventListener('touchmove',preventDefault,false);
    document.body.addEventListener('touchmove',preventDefault,true);
    window.addEventListener('touchmove',preventDefault,true);
    // end here

    // add to home screen
    addToHomescreen();

    // generateSongHTMLInPlaylist(playlistData);

    window.addEventListener('visibilitychange', onPageHide, false);

    // requestMusicItemListData(playURLs);
    // await playOnlinePlayList(); // this is working

    
    await addSampleSongsToDB();
    await obtainLikedSongsPlayList();


    getUserClickOnScreen();
    onHoverChangeColor();
    hideMiniPlayerWhenLaunched();


    generateSettingItems();
    
    setupAuth();
    initFirestore();

    // getOnlineLikedSongs();


    eruda.init();



    // await obtainPlayList();

    // testClick();

    // loadDogSound('https://youtubemusic.songlinhou.repl.co/music_url?url=https://www.youtube.com/watch?v=944qO4mPdaY');
});

function onPageHide(e){
    var player = $("#player2")[0];
    if(player.paused){
        logDebug("player is paused");
    }
}

// function iosLimitationUI(){
//     if(onIOS){
//         $(".main-play-btn").css("color", "gray");
//         $("#musicPlayerCol").addClass("d-none");
//         $("#seekObjContainer").addClass("d-none");
//     }
//     else{
//         $("#musicPlayerCol").removeClass("d-none");
//         $("#embededPlayerCol")[0].remove();
//     }
// }

function initPlayer(){
    if(!useMusicBase64){
        return;
    }
    if(playerInit){
        return;
    }
    $("#player2").attr("src", "data:audio/mp4;base64," + noticeSound);
    $("#player2")[0].load();
    $("#player2")[0].play();
    $("#ios-enter-modal").modal('hide');
    logDebug("iOS player inited.");
    playerInit = true;
}
var isDragging = false;
function getUserClickOnScreen(){
    if(!useMusicBase64){
        return;
    }
    $("#ios-enter-modal").modal({backdrop: 'static', keyboard: false});
    $("#ios-enter-modal").modal('show');

    $("#ios-enter-modal").off("click");
    $("#ios-enter-modal").on("click", (e)=>{initPlayer();});
    $("#ios-enter-modal").on("mousedown", (e)=>{initPlayer();});

    // $("#screen-enter-btn").off("click");
    // $("#screen-enter-btn").on("click", (e)=>{
    //     $("#player2").attr("src", "data:audio/mp4;base64," + noticeSound);
    //     $("#player2")[0].load();
    //     $("#player2")[0].play();
    //     $("#ios-enter-modal").modal('hide');
    //     logDebug("iOS player inited.");
    //     playerInit = true;
    // });
    // $("#enter-modal-close-btn").on("click", (e)=>{
    //     $("#player2").attr("src", "data:audio/mp4;base64," + noticeSound);
    //     $("#player2")[0].load();
    //     $("#player2")[0].play();
    //     $("#ios-enter-modal").modal('hide');
    //     logDebug("iOS player inited.");
    //     playerInit = true;
    // });
}




function setupBottomNav(){
    $("#home-nav-btn").on("click", (e) => {
        doPlayerInitOnClick();
        // console.log("click home");
        // onClickHome();
        // showMiniPlayer();
        // clearBottomNavBtnStyle();
        // $("#home-nav-btn").css("color","white");
    });

    $("#playlist-nav-btn").on("click", (e) => {
        doPlayerInitOnClick();
        onClickPlaylist();
        showMiniPlayer();
        clearBottomNavBtnStyle();
        $("#playlist-nav-btn").css("color","white");
    });

    $("#search-nav-btn").on("click", (e) => {
        doPlayerInitOnClick();
        onClickSearch();
        showMiniPlayer();
        clearBottomNavBtnStyle();
        $("#search-nav-btn").css("color","white");
    });

    $("#user-nav-btn").on("click", (e) => {
        doPlayerInitOnClick();
        onClickUser();
        clearBottomNavBtnStyle();
        $("#user-nav-btn").css("color","white");
    });
    

    $("#float-player-left").on("click", (e) => {
        // show the main play window
        showMainPlayerWindow();
    });

    $("#main-song-cover").on("click", (e) =>{
        doPlayerInitOnClick();
        console.log("click main cover");
        $("#main-song-cover").addClass("d-none");
        $("#main-song-cover2").hide();
        $("#main-song-cover2").removeClass("d-none");
        $("#main-song-cover2").fadeIn("slow");
    });

    $("#main-song-cover2").on("click", (e) =>{
        doPlayerInitOnClick();
        console.log("click main cover2");
        $("#main-song-cover2").addClass("d-none");
        $("#main-song-cover").hide();
        $("#main-song-cover").removeClass("d-none");
        $("#main-song-cover").fadeIn("slow");
    });

    $("#next-song-btn").on("click", async (e) => {
        doPlayerInitOnClick();
        console.log("click next song");
        $("#player2")[0].pause();
        await playNextSongInPlaylist();
    });

    $("#prev-song-btn").on("click", (e) => {
        doPlayerInitOnClick();
        console.log("click prev song");
        playPrevSongInPlaylist();
    });

    $(".main-play-horizontal-btn").on("click", (e) => {
        doPlayerInitOnClick();
        
        
        $("#main-play-container").animate({
            opacity: 0,
            marginTop: '-200px',
        }, 'slow', 'linear', function(){
            // $(this).hide();
            $(".main-page").fadeOut("slow");

            let lastPageId = "#" + currentViewingPageId;
            $(lastPageId).hide();
            $(lastPageId).removeClass("d-none");
            $(lastPageId).fadeIn("slow");

            showMiniPlayer();
            // setting back container info
            $(this).hide();
            $("#main-play-container").css("opacity", "100");
            $("#main-play-container").css("margin-top", "0px");

        });
        
    });

    // $("#main-player-download-btn").on("click", (e) => {
    //     doPlayerInitOnClick();
    //     if(!currentPlayingSongCode || currentPlayingSongCode == null){
    //         downloadMusic(currentPlayingSongCode);
    //     }
    //     else{
    //         console.log("no song is selected.");
    //     }
    // });

    // play list (liked songs)
    $("#playlist-playall-btn").on("click",async (e)=>{
        doPlayerInitOnClick();
        if(viewingPlaylistData.length > 0){
            await playViewingPlayList();
        }
    });

    $("#return-to-playlist-btn").on("click",(e)=>{
        doPlayerInitOnClick();
        $("#playlist-items-container").addClass("d-none");
        $("#main-playlist-container").hide();
        $("#main-playlist-container").removeClass("d-none");
        $("#main-playlist-container").fadeIn();
    });

    $("#liked-songs-item").on("click",(e)=>{
        doPlayerInitOnClick();
        $("#main-playlist-container").addClass("d-none");
        $("#playlist-items-container").hide();
        $("#playlist-items-container").removeClass("d-none");
        $("#playlist-items-container").fadeIn();
    });

    $("#add-to-playlist-btn").on("click",async (e)=>{
        doPlayerInitOnClick();
        $("#add-to-playlist-modal").modal('show');
        $("#error-in-adding-link").addClass("d-none");
        let possibleURL = await attemptClipboardURL();
        let url = $("#url-add-input").val(possibleURL);
    });

    let syncClickLastTime = null;
    $("#sync-playlist-btn").on("click",async (e)=>{
        doPlayerInitOnClick();
        if(!syncClickLastTime){
            $('#sync-playlist-btn').fadeOut(250).fadeIn(250);
            // await syncLocalAndRemoteLikedSongs(); // sync
            await overrideLocalFromRemote();
            syncClickLastTime = Date.now();
            return;
        }
        let timeElaspedInSeconds = (Date.now() - syncClickLastTime) / 1000;
        if(timeElaspedInSeconds >= 5)
        {
            $('#sync-playlist-btn').fadeOut(250).fadeIn(250);
            // await syncLocalAndRemoteLikedSongs(); // sync
            await overrideLocalFromRemote();
            syncClickLastTime = Date.now();
        }
        else{
            console.log("must wait for 5 seconds before next refresh", timeElaspedInSeconds);
        }
        
    });

    

    onHoverChangeColor();
    
    // add URL modal
    $("#comfirm-add-url-btn").on("click", confirmAddURL);

    $("#add-url-and-play-btn").on("click", async ()=>{
        doPlayerInitOnClick();
        let url = $("#url-add-input").val().trim();
        let success = await confirmAddURL();
        if(success){
            // let songData = await getLikedSongFromDB(url);
            // console.log('songData=', songData);
            await playViewingPlayList();
        }
    });

    // search music 
    $('#search-input').keypress(async function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13'){
            await onStartNewSearch();

        }
    });

    $("#search-song-btn").on("click", async ()=>{
        let spinnerHidden = $("#loading-indicator").hasClass("d-none");
        if(spinnerHidden){
            await onStartNewSearch();
        }
    });

    $("#load-more-search-btn").on("click", async ()=>{
        let spinnerHidden = $("#loading-indicator").hasClass("d-none");
        if(spinnerHidden){
            await onStartNewSearch();
        }
    });
}
let lastSearchTimestamp = null;
async function onStartNewSearch(){
    doPlayerInitOnClick();
    if(!lastSearchTimestamp)
    {
        lastSearchTimestamp = Date.now();
    }
    else{
        let timeElaspInSec = (Date.now() - lastSearchTimestamp) / 1000;
        if(timeElaspInSec <= 3){
            console.log("please try again later");
            return;
        }
    }
    currentLikedSongCodes = await getCurrentLocalLikedSongCodes();
    let searchKeywords = $("#search-input").val().trim();
    if(searchKeywords.length == 0){
        console.log("no keyword provided");
        return;
    }
    searchPageIdx = 0;
    await generateSearchResults(searchKeywords)
    lastSearchTimestamp = Date.now();
    
}

async function onNextSearchPage(){
    doPlayerInitOnClick();
    if(!lastSearchTimestamp)
    {
        lastSearchTimestamp = Date.now();
    }
    else{
        let timeElaspInSec = (Date.now() - lastSearchTimestamp) / 1000;
        if(timeElaspInSec <= 3){
            console.log("please try again later");
            return;
        }
    }
    currentLikedSongCodes = await getCurrentLocalLikedSongCodes();
    let searchKeywords = $("#search-input").val().trim();
    if(searchKeywords.length == 0){
        console.log("no keyword provided");
        return;
    }
    if(searchPageIdx != null){
        searchPageIdx += 1;
    }
    await generateSearchResults(searchKeywords)
    lastSearchTimestamp = Date.now();
}

function hideMiniPlayerWhenLaunched(){
    if(!currentPlayingSongCode){
        $("#float-player").addClass("d-none");
        $("#float-player").hide();
        $("#float-player").removeClass("d-none");
    }
}

function defineLikeButton(){
    if(!currentPlayingSongCode){
        console.log("currentPlayingSongCode is null");
        return;
    }
    $(".heart-btn").off("click");
    let alreadyLiked = currentLikedSongCodes.includes(currentPlayingSongCode);
    if(alreadyLiked){
        $(".heart-btn").removeClass("fa-regular");
        $(".heart-btn").addClass("fa-solid");
    }
    else{
        $(".heart-btn").removeClass("fa-solid");
        $(".heart-btn").addClass("fa-regular");
    }
    $(".heart-btn").on("click", async ()=>{
        if(alreadyLiked){
            // remove from the likedList
            await deleteMusic(currentPlayingSongCode);
            $(".heart-btn").removeClass("fa-solid");
            $(".heart-btn").addClass("fa-regular");
        }
        else{
            // add to likedList
            let item = playlistData[currentIdxInPlayList];
            await addOneRecordToLikedSongs(item);
            console.log("add to liked songs");
            $(".heart-btn").removeClass("fa-regular");
            $(".heart-btn").addClass("fa-solid");
        }
    });
}

function showMainPlayerWindow(){
    doPlayerInitOnClick();
    onHoverChangeColor();
    console.log("click player");
    $('.player-panel').fadeIn();

    let mainSongCoverMaxHeight = screen.height - 450;
    console.log("mainSongCoverMaxHeight=", mainSongCoverMaxHeight );
    $("#main-song-cover").css("height", mainSongCoverMaxHeight + "px");
    $("#main-song-cover").css("width", mainSongCoverMaxHeight + "px");

    $("#main-song-cover2").css("height", mainSongCoverMaxHeight + "px");
    $("#main-song-cover2").css("width", mainSongCoverMaxHeight + "px");

    $("#videoPlayerIFrame").css("height", mainSongCoverMaxHeight + "px");
    $("#videoPlayerIFrame").css("width", "100%");
    // $("#videoPlayerIFrame").contents().find("#player").css("height", mainSongCoverMaxHeight - 50 + "px");
    


    $(".main-page").fadeOut("slow");
    $("#main-play-container").hide();
    $("#main-play-container").removeClass("d-none");
    $("#main-play-container").fadeIn("slow");

    // hide the mini-player
    $("#float-player").hide();
    $("#float-player").fadeIn("slow");
    $("#float-player").addClass("d-none");


    defineLikeButton();
    // opacity: 100; margin-top: 0px;

    // $(".main-page").fadeOut("slow");
    // $("#main-play-container").show();
    // $("#main-play-container").css("margin-top", "-200px");
    // $("#main-play-container").animate({
    //         opacity: 100,
    //         marginTop: '0px',
    //     }, 'slow', 'linear', function(){
    //         // hide the mini-player
    //         $("#float-player").hide();
    //         $("#float-player").fadeIn("slow");
    //         $("#float-player").addClass("d-none");
    //     });
}

async function attemptClipboardURL(){
    let text = await navigator.clipboard.readText();
    text = text.trim();
    if (text.indexOf("watch?v=") > 0){
        return text;
    }
    if (text.startsWith("https://youtu.be/")){
        return text;
    }
    return '';
}

async function confirmAddURL(){
    doPlayerInitOnClick();
    console.log("click add");
    let url = $("#url-add-input").val().trim();
    if(url.length == 0){
        console.log("cannot add a blank URL");
        let errorMsg = 'YouTube video link cannot be blank.';
        $("#error-in-adding-link").html(errorMsg);
        $("#error-in-adding-link").removeClass("d-none");
        return false;
    }
    let success = await addURLToLiked(url);
    if(success){
        $("#add-to-playlist-modal").modal('hide');
        let $firstItem = $($(".song-item")[0]);
        $firstItem.addClass("d-none");
        $firstItem.hide();
        $firstItem.removeClass("d-none");
        $firstItem.fadeIn()
        return true;
    }
    else{
        console.log("cannot add URL");
        // add some UI changes here
        let errorMsg = 'Not a valid YouTube video link.';
        $("#error-in-adding-link").html(errorMsg);
        $("#error-in-adding-link").removeClass("d-none");
        return false;
    }
}

function showMiniPlayer(){
    // show mini-player
    // $('#playlist-nav-btn')[0].classList.contains('col')
    if($("#float-player").is(':hidden')){
        $("#float-player").hide();
        $("#float-player").removeClass("d-none");
        $("#float-player").fadeIn();
    }
}

function clearBottomNavBtnStyle(){
    $(".bottom-nav-btn").css("color","");
}


function onClickHome() {
    currentViewingPageId = "main-home-container";
    $(".main-page").fadeOut("slow");
    $("#main-home-container").hide();
    $("#main-home-container").removeClass("d-none");
    $("#main-home-container").fadeIn("slow");
}

function onClickUser() {
    currentViewingPageId = "user-center-container";
    $(".main-page").fadeOut("slow");
    $("#" + currentViewingPageId).hide();
    $("#" + currentViewingPageId).removeClass("d-none");
    $("#" + currentViewingPageId).fadeIn("slow");
}

function testPlayMusic(){
    let url = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
    let name = "Funky Music";
    let artist = "some one";
    let image = "https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/koffee-selena-etc-1577124309.jpg";
    startPlaySong(url, name, artist, image);
}

function onClickPlaylist() {
    console.log("onClickPlaylist");
    onHoverChangeColor();
    currentViewingPageId = "playlist-combined-container";
    $(".main-page").fadeOut("slow");
    $("#playlist-combined-container").hide();
    $("#playlist-combined-container").removeClass("d-none");
    $("#playlist-combined-container").fadeIn("slow");
    // testPlayMusic();
}

function onClickSearch(){
    console.log("onClickSearch");
    currentViewingPageId = "search-container";
    $(".main-page").fadeOut("slow");
    $("#search-container").hide();
    $("#search-container").removeClass("d-none");
    $("#search-container").fadeIn("slow");
    $(document).scrollTop(0);
}

function audioPlay() {
    /*var player = document.getElementById("player2");*/
  var player = $("#player2")[0];
    initProgressBar();
    // isPlaying = true;
    isPlaying = false;
}

function initProgressBar() {
    player1 = document.getElementById("player2");
    player1.addEventListener("timeupdate", timeCal);
    var playBtn = $(".main-play-btn");

    $(".end-time").html("--:--");
    $(".start-time").html("00:00");

    playBtn.click(function() {
        // if(onIOS){
        //     console.log("disabld on IOS");
        //     return;
        // }
        console.log("click play")
    if (player1.paused === false) {
        player1.pause();
        isPlaying = false;
        $(".play-pause").empty().text("PLAY");
        // playBtn.removeClass("fa-circle-pause");
        // playBtn.addClass("fa-circle-play");
        updatePlayBtn(false);



    } else {
        player1.play();
        isPlaying = true;
        $(".play-pause").empty().text("PAUSE");
        // playBtn.removeClass("fa-circle-play");
        // playBtn.addClass("fa-circle-pause");
        updatePlayBtn(true);
    }
    });

}

function updatePlayBtn(showPause){
    if(showPause){
        $("#mini-play-btn").addClass("fa-pause");
        $("#mini-play-btn").removeClass("fa-play");
        $("#major-play-btn").addClass("fa-circle-pause");
        $("#major-play-btn").removeClass("fa-circle-play");
    }
    else{
        $("#mini-play-btn").removeClass("fa-pause");
        $("#mini-play-btn").addClass("fa-play");
        $("#major-play-btn").removeClass("fa-circle-pause");
        $("#major-play-btn").addClass("fa-circle-play");
    }
}

function startPlaySongBase64(url, name, artist, image, desc="No information found", length=0, base64="", playImmediately=true){
    console.log("startPlaySongBase64");
    let player = $("#player2")[0];
    $("#player2").attr("src", base64);
    player.load();
    

    updatePlayBtn(false);

    $(".song-cover").attr("src", image);
    $(".song-name").html(name);
    $(".artist-name").html(artist);
    $("#song-desc").html(desc)
    current_song_length = length;

    $("#main-song-cover2").css("background-image", `linear-gradient(rgba(0, 0, 0, 0.8), rgba(0,0,0,0.8)), url('${image}')`);
    $("#main-song-cover2").css("background-size", 'cover');
    $("#main-song-cover2").scrollTop(0); // set description scrollbar to top



    $("#mini-progress-bar").css("width", "0%");
    var progressbar = document.getElementById("seekObj1");
    progressbar.style.marginLeft = "0px";

    // playBtn.addClass("fa-circle-pause");
    // playBtn.removeClass("fa-circle-play");
    updatePlayBtn(true);

    if(playImmediately){
        setTimeout(() => {
            console.log("now playing " + name);
            isLoadingNow = true;
            performanceStats['playStartTime'] = Date.now();
            player.play();
            console.log("play is called");
            performanceStats['playDelay'] = Date.now();
            // back to cover
            $("#main-song-cover2").addClass("d-none");
            $("#main-song-cover").hide();
            $("#main-song-cover").removeClass("d-none");
            $("#main-song-cover").fadeIn("slow");
        }, 10);

    }
}


function startPlaySong(url, name, artist, image, desc="No information found", length, playImmediately=true){
    var playBtn = $(".main-play-btn");
    $(".end-time").html("--:--");
    $(".start-time").html("00:00");
    player1 = $("#player2")[0];

    player1.pause();
    // isPlaying = false;
    // var context = new (window.AudioContext || window.webkitAudioContext)();
    // let ctx = new window.AudioContext();
    // let delay = ctx.createDelay(1);
    // delay.delayTime.value = 0;
    // $("#player-source")[0].connect(delay);

    $("#player-source").attr("src", url);
    // playBtn.removeClass("fa-circle-pause");
    // playBtn.addClass("fa-circle-play");
    updatePlayBtn(false);

    $(".song-cover").attr("src", image);
    $(".song-name").html(name);
    $(".artist-name").html(artist);
    $("#song-desc").html(desc)
    current_song_length = length;

    $("#main-song-cover2").css("background-image", `linear-gradient(rgba(0, 0, 0, 0.8), rgba(0,0,0,0.8)), url('${image}')`);
    $("#main-song-cover2").css("background-size", 'cover');
    $("#main-song-cover2").scrollTop(0); // set description scrollbar to top



    $("#mini-progress-bar").css("width", "0%");
    var progressbar = document.getElementById("seekObj1");
    progressbar.style.marginLeft = "0px";
    updatePlayBtn(true);

    player1.load();

    if(playImmediately){
        setTimeout(() => {
            console.log("now playing " + name);
            isLoadingNow = true;
            player1.play();
            performanceStats['playStartTime'] = Date.now();

            // back to cover
            $("#main-song-cover2").addClass("d-none");
            $("#main-song-cover").hide();
            $("#main-song-cover").removeClass("d-none");
            $("#main-song-cover").fadeIn("slow");

        }, 500);

    }
}

function onHoverChangeColor(){
    console.log("onHoverChangeColor called");
    $(".song-item").hover(function(){
         $(this).css("background-color", "#222");
         $(".song-item").css("cursor", "pointer");
        }, 
         function(){
             $(this).css("background-color", "");
             $(".song-item").css("cursor", "");
    });
    $(".main-play-horizontal-btn").hover(()=>{
        $("#main-play-top-line").css(
            "background-color", "#ddd"
        );
        $("#main-play-top-line").css("cursor", "pointer");
    },()=>{
        $("#main-play-top-line").css(
            "background-color", "#bbb"
        );
        $("#main-play-top-line").css("cursor", "");
    });
}


async function loadSongFromPlaylist(id, playImmediately=true){
    // might need to check if it is the same song
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    currentLikedSongCodes = await getCurrentLocalLikedSongCodes();
    let songData = playlistData[id];
    if(!currentPlayingSongCode){
        currentPlayingSongCode = getVideoCode(songData['original_url']);
    }
    else if(getVideoCode(songData['original_url']) == currentPlayingSongCode){
        showMainPlayerWindow();
        console.log("load the playing song. show mini player instead.");
        return;
    }
    $("#player2")[0].pause();
    // onHoverChangeColor();
    
    console.log("setting color");
    $('.song-item-row').css("background-color", "");
    $(`[song-idx=${id}]`).parent().closest('.song-item-row').css("background-color", "#333");

    setTimeout(()=>{
        avoidFastClick = false;
        logDebug("****** now click is enabled");
    }, 2000);
    currentPlayingSongCode = getVideoCode(songData['original_url']);
    if(useMusicBase64){
        let originalURL = songData['original_url'];
        console.log("requesting base64 for song", songData['name']);
        let timeStamp = Date.now();
        let songItemData = await getMusicBase64(originalURL);
        let timeElapsed = Math.floor( (Date.now() - timeStamp) / 1000);
        console.log(`Time spent for getting base64 = ${timeElapsed} seconds`);
        
        startPlaySongBase64(songData['url'], songData['name'], songData['artist'], songData['image'], songData['desc'], songData['length'], songItemData['code'], playImmediately);
    }
    else{
        startPlaySong(songData['url'], songData['name'], songData['artist'], songData['image'], songData['desc'], songData['length'], playImmediately);
    }
}

async function playNextSongInPlaylist(playImmediately=true){
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    if (currentIdxInPlayList < 0 || currentIdxInPlayList > playlistData.length - 1){
        console.log("reset index to 0");
        currentIdxInPlayList = 0;
    }
    else{
        currentIdxInPlayList += 1;
        currentIdxInPlayList = currentIdxInPlayList % playlistData.length;
    }

    await loadSongFromPlaylist(currentIdxInPlayList, playImmediately);

}

async function playPrevSongInPlaylist(playImmediately=true){
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    if (currentIdxInPlayList < 0 || currentIdxInPlayList > playlistData.length - 1){
        console.log("reset index to 0");
        currentIdxInPlayList = 0;
    }
    if (currentIdxInPlayList == 0){
        currentIdxInPlayList = playlistData.length - 1;
    } 
    else{
        currentIdxInPlayList -= 1;
        currentIdxInPlayList = currentIdxInPlayList % playlistData.length;
    }

    await loadSongFromPlaylist(currentIdxInPlayList, playImmediately);

}

function isDropdownVisible(){
    return $('.dropdown-menu.show').length > 0;
}

function closeDropdown(){
    $('.dropdown-menu').removeClass('show');
}

async function obtainPlayList(){
    let playListItems = await requestMusicItemListData(playURLs);
    viewingPlaylistData = playListItems;
    generateSongHTMLInPlaylist(viewingPlaylistData);
    $('.song-click-area').off("click");
    $('.song-click-area').on("click",async (e)=>{
        let dropdownVisible = isDropdownVisible();
        if(dropdownVisible){
            console.log("dismiss the dropdown");
            closeDropdown();
            e.preventDefault();
            return;
        }
        console.log("target=", $(e.target));
        let $idItem = $(e.target).parent().closest('.song-click-area'); 
        let idx = parseInt($idItem.attr("song-idx"));
        console.log(`click song ${idx} to play`);
        showMiniPlayer();
        playlistData = viewingPlaylistData;
        currentIdxInPlayList = idx;
        await loadSongFromPlaylist(currentIdxInPlayList, true);
        // $('.song-item-row').css("background-color", "#000");
        // $idItem.parent().closest('.song-item-row').css("background-color", "#222");
    });
    defineSongOperations();

}

let avoidFastClick = false;
async function obtainLikedSongsPlayList(){
    let playListItems = await getAllLikedSongs();
    console.log("song meta from local likedsongs:", playListItems);
    let numLikedSongs = playListItems.length;
    if(numLikedSongs == 0){
        console.log('no liked song yet. add some? GUI modal here');
        $("#numberOfLikedSongs").html("empty");
        return;
    }
    $("#numberOfLikedSongs").html(`${numLikedSongs} songs available`);

    viewingPlaylistData = playListItems;
    generateSongHTMLInPlaylist(viewingPlaylistData);
    $('.song-click-area').off("click");
    $('.song-click-area').on("click",async (e)=>{
        let dropdownVisible = isDropdownVisible();
        if(dropdownVisible){
            console.log("dismiss the dropdown");
            closeDropdown();
            e.preventDefault();
            return;
        }
        console.log("target=", $(e.target));
        let $idItem = $(e.target).parent().closest('.song-click-area');
         
        let idx = parseInt($idItem.attr("song-idx"));
        console.log(`click song ${idx} to play`);
        showMiniPlayer();
        playlistData = viewingPlaylistData;
        currentIdxInPlayList = idx;
        
        if(avoidFastClick){
            return;
        }
        if(!avoidFastClick){
            logDebug("***** click guard is enabled.")
            avoidFastClick = true;
            await loadSongFromPlaylist(currentIdxInPlayList, true);
        }
        
    });
    defineSongOperations();
}

function defineSongOperations(){
    $(".song-dropdown-btn").off("click");
    $(".song-dropdown-btn").on("click", (e)=>{
        doPlayerInitOnClick();
        let $target = $(e.target).parent().closest('.song-item');
        let code = $target.attr('code');
        console.log("operation target=", $target, "code=", code);
        console.log("click on", e.target);
        // let $btnTarget = $(e.target).parent().closest('.song-dropdown-btn');
        let $btnTarget = $(e.target);

        

        let action = $btnTarget.attr("action-type");
        console.log("btnTarget=", $btnTarget);
        console.log("action=", action);
        
        if(action == "copy-youtube"){
            copyYTLink(code);
        }
        else if(action == "copy-player"){
            copyPlayerLink(code);
        }
        else if(action == "download"){
            downloadMusic(code);
        }
        else if(action == "delete"){
            deleteMusic(code);
            $(`.song-item[code=${code}]`).fadeOut();
            setTimeout(()=>{
                $(`.song-item[code=${code}]`).remove();
            }, 1000);
        }
    });
}

function copyYTLink(code){
    let yt = generateYTVideoLink(code);
    navigator.clipboard.writeText(yt);
    alert("copied");
}

function copyPlayerLink(code){
    alert("coming soon...");
}




async function addSampleSongsToDB(){
    let playListItems = await getAllLikedSongs();
    if(playListItems.length > 0){
        console.log('already have some liked songs. skip...');
        return;
    }
    let sampleBulkData = await requestMusicItemListData(playURLs);

    for(let i=0; i < sampleBulkData.length; i++){
        const rec = sampleBulkData[i];
        rec['data'] = 0;
        rec['timestamp'] = 0;
    }
    await addBulkRecordsToLikedSongs(sampleBulkData);
}

function toggleSearchLoadingSpinner(show){
    let height = window.innerHeight - 32 - 32 - 30 - 60 - 64;
    $("#loading-indicator").css("height", height + "px");
    if(show){
        $("#loading-indicator").hide();
        $("#loading-indicator").removeClass("d-none");
        $("#loading-indicator").fadeIn();
        $("#search-song-btn").addClass("disabled");
    }
    else{
        $("#loading-indicator").fadeOut();
        $("#loading-indicator").addClass("d-none");
        $("#search-song-btn").removeClass("disabled");
    }
}



let searchPageIdx = 0;
async function generateSearchResults(keyword){
    toggleSearchLoadingSpinner(true);
    $("#search-results").addClass("d-none");
    let searchItems = await requestMusicSearchResults(keyword, searchPageIdx);
    let html = "";
    for(let i=0; i < searchItems.length; i++){
        const rec = searchItems[i];
        html += getSongItemHTML(i, rec.name, rec.artist, rec.image, rec.code, false);
    }
    $("#search-songitem-list").html(html);
    $("#search-results").removeClass("d-none");
    toggleSearchLoadingSpinner(false);
    $(window).scrollTop(0);

    viewingPlaylistData = searchItems;
    $('.song-click-area').off("click");
    $('.song-click-area').on("click",async (e)=>{
        let dropdownVisible = isDropdownVisible();
        if(dropdownVisible){
            console.log("dismiss the dropdown");
            closeDropdown();
            e.preventDefault();
            return;
        }
        console.log("target=", $(e.target));
        let $idItem = $(e.target).parent().closest('.song-click-area');
         
        let idx = parseInt($idItem.attr("song-idx"));
        console.log(`click song ${idx} to play`);
        showMiniPlayer();
        playlistData = viewingPlaylistData;
        currentIdxInPlayList = idx;
        
        if(avoidFastClick){
            console.log("cannot play due to avoid fast click");
            return;
        }
        if(!avoidFastClick){
            logDebug("***** click guard is enabled.")
            avoidFastClick = true;
            await loadSongFromPlaylist(currentIdxInPlayList, true);
        }
        
    });
    $("#load-more-container").removeClass("d-none");
    defineSongOperations();
}

async function addURLToLiked(url){
    let tempURL = {'urls': [url]};
    let sampleBulkData = await requestMusicItemListData(tempURL);
    let data = sampleBulkData[0];
    if (Object.keys(data).length > 0){
        data['data'] = 0;
        data['timestamp'] = getTimestampNow();
        await addOneRecordToLikedSongs(data);
        // add to server also
        await addLikedSongsToOnlineStore(data['name'], data['code']);
        await obtainLikedSongsPlayList();
        console.log("add to liked songs successfully");
        return true;
    }
    else{
        console.log("error in adding URL.");
        return false;
    }
}

async function playViewingPlayList(){
    playlistData = viewingPlaylistData;
    console.log("playViewingPlayList", playlistData);
    currentIdxInPlayList = -1;
    await playNextSongInPlaylist(true);
}

function onMusicLoadingComplete(){
    let timeElapsed = Math.floor( (Date.now() - performanceStats['playStartTime']) / 1000);
    let delayElapsed = Math.floor( (Date.now() - performanceStats['playDelay']) / 1000); 
    console.log("music loading completed. Time used for loading: " + timeElapsed + " seconds.");
    console.log("Time used in system delay: " + delayElapsed + " seconds.");

}

function setMainProgressBarPercent(percent){
    let percentStr = (percent + 0.5) + "%";
    $("#main-progress-bar").css("width", percentStr);
}

async function timeCal() {
    // if(currentSongFinished){
    //     return;
    // }
    console.log("timeCal is called");
    // preventAutoPlayNextSong = true;
    if(isLoadingNow){
        onMusicLoadingComplete();
        isLoadingNow = false;
    }
    var width = $("#timeline1").width();
    // var length = player1.duration;
    var length = current_song_length;
    var current_time = player1.currentTime;
    

    // calculate total length of value

    var totalLength = calculateTotalValue(length);
  //console.info(totalLength);
    $(".end-time").html(totalLength);

    // calculate current value time
    var currentTime = calculateCurrentValue(current_time);
    $(".start-time").html(currentTime);

    var progressbar = document.getElementById("seekObj1");
    progressbar.style.marginLeft = width * (player1.currentTime / length) + "px";
    // var percent = player1.currentTime / player1.duration * 100;
    var percent = player1.currentTime / length * 100;
    // logDebug("percent=" + percent);
    setMainProgressBarPercent(percent);

    $("#mini-progress-bar").css("width", percent + "%");

    if (length > 0){
        let remainingTime = player1.currentTime - length;
        // console.log("remaining time:", remainingTime);
        if(remainingTime >= -1){
            player1.pause();
            player1.currentTime = 0;
            currentSongFinished = true;
            if(loopPlayList){
                if(!preventAutoPlayNextSong){
                    console.log("play next song");

                    await playNextSongInPlaylist(true);
                }
                else{
                    console.log("preventing autoplay next song");
                }
            }
        }

    }
    

}

function calculateTotalValue(length) {
    var minutes = Math.floor(length / 60);
    var  seconds_int = length - minutes * 60;
    if(seconds_int < 10){
        seconds_int = "0"+seconds_int;
    }
    var seconds_str = seconds_int.toString();
    var  seconds = seconds_str.substr(0, 2);
    var time = minutes + ':' + seconds;
    return time;
}

function calculateCurrentValue(currentTime) {
    var current_hour = parseInt(currentTime / 3600) % 24,
        current_minute = parseInt(currentTime / 60) % 60,
        current_seconds_long = currentTime % 60,
        current_seconds = current_seconds_long.toFixed(),
        current_time = (current_minute < 10 ? "0" + current_minute : current_minute) + ":" + (current_seconds < 10 ? "0" + current_seconds : current_seconds);
    return current_time;
}

function ballSeek() {
     onplayhead = null;
     playerId = null;
     timeline = document.getElementById("timeline1");
     playhead = document.getElementById("seekObj1");
     timelineWidth = timeline.offsetWidth - playhead.offsetWidth;

    timeline.addEventListener("click", seek);
    playhead.addEventListener('mousedown', drag);
    window.addEventListener('mouseup', mouseUp);
    
}


function seek(event) {
    var player = document.getElementById("player2");
    // player.currentTime = player.duration * clickPercent(event, timeline, timelineWidth);
    let percent = clickPercent(event, timeline, timelineWidth);
    // alert("percent="+percent);
    player.currentTime = current_song_length * percent;

}

function clickPercent(e, timeline, timelineWidth) {
    timeline = document.getElementById("timeline1");
    playhead = document.getElementById("seekObj1");
    timelineWidth = timeline.offsetWidth - playhead.offsetWidth;
    return (event.clientX - getPosition(timeline)) / timelineWidth;
}

function getPosition(el) {
    return el.getBoundingClientRect().left;
}

function drag(e) {
    console.log("drag...")
    player1.removeEventListener("timeupdate", timeCal);
    onplayhead = $(this).attr("id");
    // playerId = $(this).parents("li").find("audio").attr("id");
    playerId = $("#player2").attr("id");
    console.log("playerId=", playerId)
    var player = document.getElementById(playerId);
    window.addEventListener('mousemove', dragFunc);
    player.removeEventListener('timeupdate', timeUpdate);
}


function dragFunc(e) {
    var player = document.getElementById(onplayhead);
    var newMargLeft = e.clientX - getPosition(timeline);

    if (newMargLeft >= 0 && newMargLeft <= timelineWidth) {
        playhead.style.marginLeft = newMargLeft + "px";
    }
    if (newMargLeft < 0) {
        playhead.style.marginLeft = "0px";
    }
    if (newMargLeft > timelineWidth) {
        playhead.style.marginLeft = timelineWidth + "px";
    }
}

function mouseUp(e) {
    if (onplayhead != null) {
        var player = document.getElementById(playerId);
        window.removeEventListener('mousemove', dragFunc);
        player.currentTime = player.duration * clickPercent(e, timeline, timelineWidth);
        player1.addEventListener("timeupdate", timeCal);
        player.addEventListener('timeupdate', timeUpdate);
    }
    onplayhead = null;
}

function timeUpdate() {
    var player2 = document.getElementById("seekObj1");
    var player = document.getElementById("player2");
    var playPercent = timelineWidth * (player.currentTime / current_song_length);
    logDebug("player time percent:" + (player.currentTime / current_song_length))
    player2.style.marginLeft = playPercent + "px";
    // If song is over
    var playBtn = $(".main-play-btn");
    console.log("player.duration - player.currentTime=", current_song_length - player.currentTime)
    if (player.currentTime == player.duration) {
        console.log("song is over")
        player.pause();
        $(".end-time").html("--:--");
        $(".start-time").html("00:00");
        isPlaying = false;
        $(".play-pause").empty().text("PLAY");
        console.log("playBtn=", playBtn);
        playBtn.removeClass("fa-circle-pause");
        playBtn.addClass("fa-circle-play");
    }

}

function logDebug(msg){
    if(showInAppDebug){
        $("#debugInfo").html(msg);
    }
    console.log(msg);
}

        </script>

</body>
</html>