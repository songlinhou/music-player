<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="theme-color" content="#444" />
        <link href="css/style.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
        <script src="https://kit.fontawesome.com/eb0c496755.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        

        <link rel="stylesheet" href="css/addtohomescreen.css">
        <script src="src/addtohomescreen.min.js"></script>
        <script src="src/requester.js"></script>

        <link rel="apple-touch-icon" sizes="512x512" href="img/icon.png">
        <meta name="apple-mobile-web-app-title" content="Music Player">
        <link rel="icon" sizes="128x128" href="img/icon-128.png">
        <link rel="icon" sizes="512x512" href="img/icon-512.png">
        <link rel="icon" type="image/x-icon" href="img/favicon.ico">
        <link rel="manifest" href="manifest.json">
        <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
        <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
        <script src="https://cdn.plyr.io/3.7.2/plyr.polyfilled.js"></script>
        <script src="src/crossPlatform.js"></script>
        <script src="src/itemGenerator.js"></script>
        <script src="src/dataSaver.js"></script>

    </head>
    <body style="background-color: black; padding-top:30px;" class="body">
        <div class="wrapper">
        
        <div id="main-play-container" class="d-none container main-page" style="background-color:#333; padding-top: 5px; border-radius: 20px;">
            <div class="row main-play-horizontal-btn">
                
                <div class="d-flex justify-content-center">
                <div style="height: 4px; width:36px; border-radius: 2px; background-color: rgb(138, 138, 138);"></div>
                    </div>
            </div>
            <div class="main-play-horizontal-btn" style="height: 20px;"></div>
            <div class="row">
                <div class="col d-none player-panel" id="musicPlayerCol">
                    <div class="d-flex justify-content-center">
                    <img src="album-cover.jpg" class="img-fluid song-cover" id="main-song-cover" style="max-height: 360px; object-fit: cover; box-shadow: 2px 2px 20px #000;" alt="...">
                    <div id="main-song-cover2" style="background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0,0,0,0.8)), url('album-cover.jpg'); background-size: cover;" class="d-none img-fluid d-flex flex-column flex-nowrap overflow-auto" style="max-height: 360px; object-fit: cover; box-shadow: 2px 2px 20px #000;">
                        <div class="text-center" style="margin-top: 10px; margin-bottom: 10px; text-shadow: 2px 2px 8px #dddddd; color: white; filter: brightness(300%)" id="song-desc">    
                            This is the description<br>
                            
                        </div>
                        
                    </div>

                </div>
                </div>

                <div class="col player-panel" id="embededPlayerCol">
                    <div class="d-flex justify-content-center" id="videoPlayerIframeWrapper">
                    <!-- <iframe id="videoPlayerIFrame" src="videoPlayer.html" scrolling="no" frameborder="0" width="80%"></iframe> -->
                    <iframe id="videoPlayerIFrame" src="https://www.youtube.com/embed/TcpDNqkxMHY" scrolling="no" frameborder="0" width="80%" allow="autoplay;"></iframe>

                    
            </div>
            </div>

            </div>

            <div class="row" style="margin-top: 15px;">
                <div class="d-flex align-items-center">
                <div class="col">
                    <div class="d-flex justify-content-start"> <marquee width="200" direction="left" style="color: white;" class="h5 song-name">Title</marquee> </div>
                </div>

                <div class="col">
                    <div class="d-flex justify-content-end" style="color: white;">
                        <i class="fa-regular fa-heart"></i>
                    </div>
                </div>
            </div>
            </div>
            <div class="row" style="margin-top: -5px;">
                <div class="d-flex justify-content-start">
                    <div class="text-muted artist-name" style="font-size: 12px;">Singer</div>
                </div>
            </div>

            <div class="row progress-bar" style="margin-top: 24px;">
                <div class="audio-player">
                    <div id="seekObjContainer">
                        <div id="timeline1">
                            <div id="seekObj1" class="playhead" style="margin-left: 0px;"></div>
                        </div>
                    </div>
                    <!-- <div class="player-controls scrubber">
                        <small class="start-time"></small>
                      <div class="play-pause">play</div>
                        <small class="end-time"></small>
                    </div> -->
                    <div class="audio-wrapper">
                        <audio id="player2" preload="none">
                              <!-- <source id="player-source" src="http://d2cstorage-a.akamaihd.net/wbr/gotnext/8578.mp3" type="audio/mp3"> -->
                              <source id="player-source" src="https://youtubemusic.songlinhou.repl.co/music_url?url=https://www.youtube.com/watch?v=944qO4mPdaY" type="audio/mp4">

                        </audio>
                    </div>

                    <!-- <button id="start">start</button> -->
                </div>
            

                <!-- <div class="player-controls scrubber">
                    <small class="start-time"></small>
                  <div class="play-pause">play</div>
                    <small class="end-time"></small>
                </div> -->
                

            </div>

            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-start">
                    <div style="font-size: 12px;" class="start-time text-muted"></div></div>
                </div>

                <div class="col">
                    <div class="d-flex justify-content-end">
                    <div style="font-size: 12px;" class="end-time text-muted"></div></div>
                </div>
            </div>

            <div class="row" style="margin-top: 24px; color:white;">
                <div class="d-flex align-items-center">
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-cloud-arrow-down"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-backward-step" id="prev-song-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-circle-play fa-2xl main-play-btn" id="major-play-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-forward-step" id="next-song-btn"></i></div></div>
                <div class="col">
                    <div class="d-flex justify-content-center">
                    <i class="fa-solid fa-list"></i></div></div>
                    </div>
            </div>

            <!-- <div class="play-pause">play</div> -->

            


            <div class="container" style="height: 20px;">

            </div>

        </div>

        <div id="main-home-container" class="d-none container main-page" style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row">
                <picture>
                    <img src="img/icon-128.png" class="img-fluid" style="height: 64px;" alt="...">
                  </picture></div>

            <div class="row" style="margin-top: 20px; margin-left: 0px;">
                <h5>Listen again</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 250px;">
                <div class="card mx-2" style="height:200px; min-width: 200px; max-width: 200px; background-color: black;">
                    <img  src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" >
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: white; font-size: 12px;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>
                  
                  <div class="card mx-2" style="width: 10rem;min-width: 200px; max-width: 200px; background-color: black;">
                    <img src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" alt="...">
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: black;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>  

                  <div class="card mx-2" style="width: 10rem; min-width: 200px; max-width: 200px; background-color: black;">
                    <img src="https://www.androidauthority.com/wp-content/uploads/2021/05/Rocket-Player-screenshot-2022.jpg" class="card-img-top" alt="...">
                    <div class="card-body" style="padding-top: 8px; padding-left: 0px; padding-right: 0px; padding-bottom: 0px;">
                      <p class="card-text" style="color: black;">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                  </div>  
            </div>

            

            </div>

            <div class="row" style="margin-top: 20px; margin-left: 0px;">
                <h5>Quick picks</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 180px;">
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div> 
                <div class="card card-block mx-2" style="min-width: 200px; ">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>           
            </div>
            </div>

            <div class="row" style="margin-top: 60px; margin-left: 0px;">
                <h5>Popular songs</h5>
            </div>
            <div class="row">
            <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 120px;">
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div> 
                <div class="card card-block mx-2" style="min-width: 200px; ">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>
                <div class="card card-block mx-2" style="min-width: 200px;">Card</div>           
            </div>
            </div>

            <form>
                <div class="form-group">
                  <label for="exampleFormControlFile1">Example file input</label>
                  <input type="file" class="form-control-file" id="exampleFormControlFile1" multiple>
                </div>
              </form>


            <div class="container" style="margin-top: 200px;">

            </div>

        </div>

        <div class="main-page" id="playlist-combined-container">
        <div id="main-playlist-container" class="container  d-none" style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row">
                <div class="col d-flex justify-content-left">
                    <i class="fa-solid fa-headphones fa-xl" style="padding-top: 12px;padding-left: 12px;"></i>
                    <h4 style="margin-left: 6px;">My Playlists</h4>
                    </div>
            </div>

            <div class="row" style="margin-top: 32px;">
                <div style="height:100%; width:100%; overflow:hidden; overflow-y:scroll;">
                    <div class="playlist-item" style="margin-bottom: 12px;">
                        <div class="row">
                            <div class="col-8">
                                <div class="d-flex justify-content-left" id="liked-songs-item">
                                <img style="border-radius: 12%; height: 45px; width: 45px; object-fit:cover; padding: 0px; margin-left: 12px;" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR2jKX0ATfz8woidgFJ-1SttFBzHyKZUJfO5Q&usqp=CAU">
                                <div class="col" style="margin-left: 12px;">
                                    <h6 style="color: white;margin-bottom: 0px;">Liked Songs</h6>
                                    <div style="color: #999; font-size: 16px;" id="numberOfLikedSongs">10 songs available</div>
                                </div>
                            </div>
                            </div>

                            <div class="col">
                                    <div class="d-flex justify-content-end">
                                        <i class="fa-solid fa-ellipsis-vertical" style="margin-top:12px; margin-right:12px;"></i>
                                    </div>

                                
                            </div>

                            
                            
                        </div>


                    </div>
                    
                    
    
                </div>
            </div>
            <div style="margin-top: 40px;"></div>

        </div>

        <div id="playlist-items-container" class="container " style="padding-top: 0px;color: #fff;  padding-left: 20px;">
            <div class="row" >
                <div class="col d-flex justify-content-left"  id="return-to-playlist-btn">
                    <i class="fa-solid fa-angle-left fa-xl" style=" padding-top: 16px;padding-left: 12px;"></i>
                    <h2 style="margin-left: 12px;">Liked Songs</h2>
                    </div>
                    <div class="col-2 d-flex justify-content-end" id="add-to-playlist-btn">
                        <i class="fa-solid fa-plus" style="margin-right: 16px;margin-top: 12px;"></i>
                    </div>
            </div>

            <div class="row" style="margin-top: 24px;">
                <div class="col d-flex justify-content-center" id="playlist-playall-btn">
                    <b>Play All</b>
                </div>
                <div class="col d-flex justify-content-center">
                    <b>Shuffled Play</b>
                </div>
            </div>

            <div class="row" style="margin-top: 32px;">
                <div style="height:100%; width:100%; overflow:hidden; overflow-y:scroll; min-height: 600px;" id="playlist-songitem-list">
                    <!-- <div class="text-center" style="color: white">List is empty.</div> -->


                    



                </div>
            </div>
            <div style="margin-top: 200px;"></div>

        </div>
    </div>



        <!-- <div class="container user-menu text-center">
            <ul>
                <li><i class="fa fa-home"></i><p>User</p></li>
                <li><i class="fa fa-music"></i><p>User</p></li>
                <li><i class="fa fa-microphone"></i><p>User</p></li>
                <li><i class="fa fa-user"></i><p>User</p></li>
            </ul>
        </div> -->

        <div class="container fixed-bottom text-center">
            <div id="float-player" class="">
                <div class="row" style="background-color: #444;">
                    <div class="col-8" id="float-player-left">
                        <div class="d-flex justify-content-left" style="margin-bottom: 6px; margin-top: 6px;">
                        <img style="height: 45px; width: 45px" class="song-cover" src="https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/best-rap-songs-1583527287.png">
                        <div class="col">
                            <div style="margin-left: 10px;">    
                        <small style="color: white;" class="d-flex justify-content-left"><marquee width="200" direction="left" style="color: white;" class="song-name">Title</marquee></small>
                        <small style="color: #999; font-size: smaller;" class="d-flex justify-content-left artist-name">Artist name</small>
                    </div>
                    </div>
                    </div>

                    
                    </div>

                    <div class="col">
                        <div class="d-flex justify-content-end" style="margin-bottom: 6px; margin-top: 6px;">
                            <div style="color: white; margin-top: 10px;" ><i class="fa-solid fa-play fa-xl main-play-btn" id="mini-play-btn"></i></div>
                            <div style="color: white; margin-top: 10px; margin-left: 30px;" ><i class="fa-regular fa-heart fa-xl"></i></div>
                        </div>
                    </div>
                </div>

                <div class="row" style="background-color:black;">
                    <div class="progress" style="height: 2px; border-radius: 0px; background-color: black; margin-left: 0px; padding-left: 0px;padding-right: 0px;">
                        <div id="mini-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                    </div>
                </div>
            </div>



            <div class="row" style="padding-top: 8px; background-color:#333; border-radius: 0px; color: #888; ">
                <div class="col bottom-nav-btn" id="home-nav-btn">
                    <i class="fa fa-home"></i><p class="nav-btn-text">Home</p>
                </div>

                <div class="col bottom-nav-btn" id="playlist-nav-btn">
                    <i class="fa fa-music"></i><p class="nav-btn-text">Playlist</p>
                </div>

                <div class="col bottom-nav-btn">
                    <i class="fa-solid fa-magnifying-glass"></i><p class="nav-btn-text">Search</p>
                </div>

                <div class="col bottom-nav-btn">
                    <i class="fa fa-user"></i><p class="nav-btn-text">User</p>
                </div>
            </div>
        </div>

        <!-- modals -->

        <div class="modal fade" id="add-to-playlist-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add New Song</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exampleFormControlInput1" class="form-label">YouTube Link</label>
                        <input class="form-control" id="url-add-input" placeholder="https://www.youtube.com/watch?v=Dzea8kRsFCI">
                        <small id="error-in-adding-link" style="color: red" class="d-none">Not a valid YouTube video link.</small>
                      </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-secondary" id="add-url-and-play-btn">Add and Play</button>
                  <button type="button" class="btn btn-primary" id="comfirm-add-url-btn">Add</button>
                </div>
              </div>
            </div>
          </div>
        </div>

    
        <script>
            var player1,onplayhead,playerId,timeline,playhead,timelineWidth,isPlaying;


let playURLs = {'urls': ['https://www.youtube.com/watch?v=Dzea8kRsFCI',
    'https://www.youtube.com/watch?v=dYAQU8qh0i4',
    'https://www.youtube.com/watch?v=944qO4mPdaY',
    'https://www.youtube.com/watch?v=qFNmFLEBAl8',
    'https://www.youtube.com/watch?v=myGNlPiTW5E',
    'https://www.youtube.com/watch?v=a-9pSJCnUeE',
    'https://www.youtube.com/watch?v=KaokgDEOKoI',
    'https://www.youtube.com/watch?v=TcpDNqkxMHY',
    'https://www.youtube.com/watch?v=istlCXqPfdM',
    'https://www.youtube.com/watch?v=uwGEWDJc2A8',

]};


let playlistData = [
    {'name': 'SoundHelix Song 1', 'artist': 'T. Schürger 1', 'image': 'https://i.ytimg.com/vi/Y0pdQU87dc8/sddefault.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', 'desc': 'Desc 1'},
    {'name': 'SoundHelix Song 2', 'artist': 'T. Schürger 2', 'image': 'https://media.timeout.com/images/105805144/750/422/image.jpg', 'url':'https://youtubemusic.songlinhou.repl.co/music_conv_url?url=https://www.youtube.com/watch?v=qFNmFLEBAl8', 'desc': 'Desc 2'},
    {'name': 'SoundHelix Song 3', 'artist': 'T. Schürger 3', 'image': 'https://www.adorama.com/alc/wp-content/uploads/2018/12/shutterstock_729861919.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', 'desc': 'Desc 3'},
    {'name': 'SoundHelix Song 4', 'artist': 'T. Schürger 4', 'image': 'https://www.musictoyourhome.com/wp-content/uploads/2021/04/8-Easy-Guitar-Songs-For-Every-Beginner.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', 'desc': 'Desc 4'},
    {'name': 'SoundHelix Song 5', 'artist': 'T. Schürger 5', 'image': 'https://www.musictoyourhome.com/wp-content/uploads/2022/02/Intermediate-Playing-Classical-Piano-Song.jpg', 'url':'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', 'desc': 'Desc 5'},
];

let viewingPlaylistData = []; // user can browse play list without changing current one.

let currentIdxInPlayList = 0;
let currentViewingPageId = "main-home-container";
let height;
let current_song_length = -1;
let isLoadingNow = false;
let loopPlayList = true;


let onIOS = false;
let disableSongClickPlay = true;

const performanceStats = {};



var preventDefault = function(e) {
    e.preventDefault();
    return false;
};

// test
var dogBarkingBuffer = null;
var context = new (window.AudioContext || window.webkitAudioContext)();

async function loadDogSound(url) {
    // var request = new XMLHttpRequest();
    // request.open('GET', url, true);
    const resp = await fetch(url);
    alert("fetch ok")
    const buf = await resp.arrayBuffer();
    alert("arrayBuffer ok")

    // Decode asynchronously

    context.decodeAudioData(buf, function(buffer) {
        dogBarkingBuffer = buffer;
        alert("decodeAudioData ok")

        playSound(dogBarkingBuffer);
    }, (e)=>{
        console.log("error=", e);
    });
    
    // request.send();
}

function playSound(buffer) {
    var source = context.createBufferSource(); // creates a sound source
    source.buffer = buffer;                    // tell the source which sound to play
    source.connect(context.destination);       // connect the source to the context's destination (the speakers)
    // source.noteOn(0);                          // play the source now
    source.start(0);
}
// test

function testClick(){
start.onclick = async (e) => {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // const audioCtx = new window.webkitAudioContext();
    // const audioCtx = new window.AudioContext();
    console.log("test click", audioCtx);
    alert(audioCtx);
    try{
    const resp = await fetch("https://youtubemusic.songlinhou.repl.co/music_url?url=https://www.youtube.com/watch?v=944qO4mPdaY");
    alert('fetch ok');
    const buf = await resp.arrayBuffer();
    alert('arrayBuffer ok');

    const source = await audioCtx.createBufferSource();
    alert('createBufferSource ok');

    const audioBuffer = await audioCtx.decodeAudioData(buf, async (arrayBuffer) => {
        alert('decodeAudioData ok');
        source.buffer = audioBuffer;
        source.playbackRate.value = 1.0;
        source.loop = true;
        source.start(0);
        const streamNode = await audioCtx.createMediaStreamDestination();
        alert('createMediaStreamDestination ok');

        source.connect(streamNode);
        alert('connect ok');

        const audioElem = new Audio();
        audioElem.controls = true;
        document.body.appendChild(audioElem);
        audioElem.srcObject = streamNode.stream; // cannot make it work on ios safari

    }, (e)=>{
        alert('decodeAudioData:' + e);
    });
    

    

    
    }
    catch(e){
        alert(e);
        
    }

    }
}

function shuffleList(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle.
  while (currentIndex != 0) {

    // Pick a remaining element.
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

function generateSongHTMLInPlaylist(playlistData){
    let html = "";
    for(let i=0; i < playlistData.length; i++){
        const rec = playlistData[i];
        html += getSongItemHTML(i, rec.name, rec.artist, rec.image)
    }
    $("#playlist-songitem-list").html(html);
}



$(window).on("load", async function () {
    onIOS = isOnIOS();
    // alert("Is IOS? " + onIOS);
    initDatabase(); // set up database

    console.log("test id=", 1);
    setupBottomNav();
    $("#main-play-container").fadeIn("slow");
    audioPlay();
    ballSeek();
    height = screen.height;
    console.log("screen height=", height);
    iosLimitationUI();
    // Hide the address bar!
    setTimeout(function(){
        window.scrollTo(0, 1);
  }, 0);
    document.addEventListener('touchmove',preventDefault,false);
    document.body.addEventListener('touchmove',preventDefault,true);
    window.addEventListener('touchmove',preventDefault,true);
    // end here

    // add to home screen
    addToHomescreen();

    // generateSongHTMLInPlaylist(playlistData);

    // window.addEventListener('visibilitychange', onPageHide, false);

    // requestMusicItemListData(playURLs);
    // await playOnlinePlayList(); // this is working

    
    // await addSampleSongsToDB();
    await obtainLikedSongsPlayList();



    // await obtainPlayList();

    // testClick();

    // loadDogSound('https://youtubemusic.songlinhou.repl.co/music_url?url=https://www.youtube.com/watch?v=944qO4mPdaY');
});

// function onPageHide(e){
//     var player = $("#player2")[0];
//   //alert(player);
//     player.play();
// }

function iosLimitationUI(){
    if(onIOS){
        $(".main-play-btn").css("color", "gray");
        $("#musicPlayerCol").addClass("d-none");
        $("#seekObjContainer").addClass("d-none");
    }
    else{
        $("#musicPlayerCol").removeClass("d-none");
        $("#embededPlayerCol")[0].remove();
    }
}


function setupBottomNav(){
    $("#home-nav-btn").on("click", (e) => {
        console.log("click home");
        onClickHome();
        showMiniPlayer();
        clearBottomNavBtnStyle();
        $("#home-nav-btn").css("color","white");
    });

    $("#playlist-nav-btn").on("click", (e) => {
        onClickPlaylist();
        showMiniPlayer();
        clearBottomNavBtnStyle();
        $("#playlist-nav-btn").css("color","white");
    });

    $("#float-player-left").on("click", (e) => {
        // show the main play window
        console.log("click player");
        $('.player-panel').fadeIn();

        let mainSongCoverMaxHeight = screen.height - 450;
        console.log("mainSongCoverMaxHeight=", mainSongCoverMaxHeight );
        $("#main-song-cover").css("height", mainSongCoverMaxHeight + "px");
        $("#main-song-cover").css("width", mainSongCoverMaxHeight + "px");

        $("#main-song-cover2").css("height", mainSongCoverMaxHeight + "px");
        $("#main-song-cover2").css("width", mainSongCoverMaxHeight + "px");

        $("#videoPlayerIFrame").css("height", mainSongCoverMaxHeight + "px");
        $("#videoPlayerIFrame").css("width", "100%");
        // $("#videoPlayerIFrame").contents().find("#player").css("height", mainSongCoverMaxHeight - 50 + "px");
        


        $(".main-page").fadeOut("slow");
        $("#main-play-container").hide();
        $("#main-play-container").removeClass("d-none");
        $("#main-play-container").fadeIn("slow");

        // hide the mini-player
        $("#float-player").hide();
        $("#float-player").fadeIn("slow");
        $("#float-player").addClass("d-none");
    });

    $("#main-song-cover").on("click", (e) =>{
        console.log("click main cover");
        $("#main-song-cover").addClass("d-none");
        $("#main-song-cover2").hide();
        $("#main-song-cover2").removeClass("d-none");
        $("#main-song-cover2").fadeIn("slow");
    });

    $("#main-song-cover2").on("click", (e) =>{
        console.log("click main cover2");
        $("#main-song-cover2").addClass("d-none");
        $("#main-song-cover").hide();
        $("#main-song-cover").removeClass("d-none");
        $("#main-song-cover").fadeIn("slow");
    });

    $("#next-song-btn").on("click", (e) => {
        console.log("click next song");
        playNextSongInPlaylist();
    });

    $("#prev-song-btn").on("click", (e) => {
        console.log("click prev song");
        playPrevSongInPlaylist();
    });

    $(".main-play-horizontal-btn").on("click", (e) => {
        $(".main-page").fadeOut("slow");
        let lastPageId = "#" + currentViewingPageId;
        $(lastPageId).hide();
        $(lastPageId).removeClass("d-none");
        $(lastPageId).fadeIn("slow");

        showMiniPlayer();
    });

    // play list (liked songs)
    $("#playlist-playall-btn").on("click",(e)=>{
        if(viewingPlaylistData.length > 0){
            playViewingPlayList();
        }
    });

    $("#return-to-playlist-btn").on("click",(e)=>{
        $("#playlist-items-container").addClass("d-none");
        $("#main-playlist-container").hide();
        $("#main-playlist-container").removeClass("d-none");
        $("#main-playlist-container").fadeIn();
    });

    $("#liked-songs-item").on("click",(e)=>{
        $("#main-playlist-container").addClass("d-none");
        $("#playlist-items-container").hide();
        $("#playlist-items-container").removeClass("d-none");
        $("#playlist-items-container").fadeIn();
    });

    $("#add-to-playlist-btn").on("click",async (e)=>{
        $("#add-to-playlist-modal").modal('show');
        $("#error-in-adding-link").addClass("d-none");
        let possibleURL = await attemptClipboardURL();
        let url = $("#url-add-input").val(possibleURL);
    });
    
    // add URL modal
    $("#comfirm-add-url-btn").on("click", confirmAddURL);

    $("#add-url-and-play-btn").on("click", async ()=>{
        let url = $("#url-add-input").val().trim();
        let success = await confirmAddURL();
        if(success){
            // let songData = await getLikedSongFromDB(url);
            // console.log('songData=', songData);
            playViewingPlayList();
        }
    });

    
}

async function attemptClipboardURL(){
    let text = await navigator.clipboard.readText();
    text = text.trim();
    if (text.indexOf("watch?v=") > 0){
        return text;
    }
    return '';
}

async function confirmAddURL(){
    console.log("click add");
    let url = $("#url-add-input").val().trim();
    if(url.length == 0){
        console.log("cannot add a blank URL");
        let errorMsg = 'YouTube video link cannot be blank.';
        $("#error-in-adding-link").html(errorMsg);
        $("#error-in-adding-link").removeClass("d-none");
        return false;
    }
    let success = await addURLToLiked(url);
    if(success){
        $("#add-to-playlist-modal").modal('hide');
        let $firstItem = $($(".song-item")[0]);
        $firstItem.addClass("d-none");
        $firstItem.hide();
        $firstItem.removeClass("d-none");
        $firstItem.fadeIn()
        return true;
    }
    else{
        console.log("cannot add URL");
        // add some UI changes here
        let errorMsg = 'Not a valid YouTube video link.';
        $("#error-in-adding-link").html(errorMsg);
        $("#error-in-adding-link").removeClass("d-none");
        return false;
    }
}

function showMiniPlayer(){
    // show mini-player
    // $('#playlist-nav-btn')[0].classList.contains('col')
    if($("#float-player").is(':hidden')){
        $("#float-player").hide();
        $("#float-player").removeClass("d-none");
        $("#float-player").fadeIn();
    }
}

function clearBottomNavBtnStyle(){
    $(".bottom-nav-btn").css("color","");
}


function onClickHome() {
    currentViewingPageId = "main-home-container";
    $(".main-page").fadeOut("slow");
    $("#main-home-container").hide();
    $("#main-home-container").removeClass("d-none");
    $("#main-home-container").fadeIn("slow");
    
}

function testPlayMusic(){
    let url = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
    let name = "Funky Music";
    let artist = "some one";
    let image = "https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/koffee-selena-etc-1577124309.jpg";
    startPlaySong(url, name, artist, image);
}

function onClickPlaylist() {
    console.log("onClickPlaylist");
    currentViewingPageId = "playlist-combined-container";
    $(".main-page").fadeOut("slow");
    $("#playlist-combined-container").hide();
    $("#playlist-combined-container").removeClass("d-none");
    $("#playlist-combined-container").fadeIn("slow");
    // testPlayMusic();
}

function audioPlay() {
    /*var player = document.getElementById("player2");*/
  var player = $("#player2")[0];
    initProgressBar();
    // isPlaying = true;
    isPlaying = false;
}

function initProgressBar() {
    player1 = document.getElementById("player2");
    player1.addEventListener("timeupdate", timeCal);
    var playBtn = $(".main-play-btn");

    $(".end-time").html("--:--");
    $(".start-time").html("00:00");

    playBtn.click(function() {
        if(onIOS){
            console.log("disabld on IOS");
            return;
        }
        console.log("click play")
    if (player1.paused === false) {
        player1.pause();
        isPlaying = false;
        $(".play-pause").empty().text("PLAY");
        // playBtn.removeClass("fa-circle-pause");
        // playBtn.addClass("fa-circle-play");
        updatePlayBtn(false);



    } else {
        player1.play();
        isPlaying = true;
        $(".play-pause").empty().text("PAUSE");
        // playBtn.removeClass("fa-circle-play");
        // playBtn.addClass("fa-circle-pause");
        updatePlayBtn(true);
    }
    });

}

function updatePlayBtn(showPause){
    if(showPause){
        $("#mini-play-btn").addClass("fa-pause");
        $("#mini-play-btn").removeClass("fa-play");
        $("#major-play-btn").addClass("fa-circle-pause");
        $("#major-play-btn").removeClass("fa-circle-play");
    }
    else{
        $("#mini-play-btn").removeClass("fa-pause");
        $("#mini-play-btn").addClass("fa-play");
        $("#major-play-btn").removeClass("fa-circle-pause");
        $("#major-play-btn").addClass("fa-circle-play");
    }
}

function startPlaySong(url, name, artist, image, desc="No information found", length, playImmediately=true){
    var playBtn = $(".main-play-btn");
    $(".end-time").html("--:--");
    $(".start-time").html("00:00");
    player1 = $("#player2")[0];

    player1.pause();
    // isPlaying = false;
    // var context = new (window.AudioContext || window.webkitAudioContext)();
    // let ctx = new window.AudioContext();
    // let delay = ctx.createDelay(1);
    // delay.delayTime.value = 0;
    // $("#player-source")[0].connect(delay);

    $("#player-source").attr("src", url);
    // playBtn.removeClass("fa-circle-pause");
    // playBtn.addClass("fa-circle-play");
    updatePlayBtn(false);

    $(".song-cover").attr("src", image);
    $(".song-name").html(name);
    $(".artist-name").html(artist);
    $("#song-desc").html(desc)
    current_song_length = length;

    $("#main-song-cover2").css("background-image", `linear-gradient(rgba(0, 0, 0, 0.8), rgba(0,0,0,0.8)), url('${image}')`);
    $("#main-song-cover2").css("background-size", 'cover');



    $("#mini-progress-bar").css("width", "0%");
    var progressbar = document.getElementById("seekObj1");
    progressbar.style.marginLeft = "0px";

    // playBtn.addClass("fa-circle-pause");
    // playBtn.removeClass("fa-circle-play");
    updatePlayBtn(true);

    player1.load();

    if(onIOS){
        playSongOnIOSEmbed(url);
        return;
    }

    if(playImmediately){
        if(onIOS){
            console.log("cannot play on IOS");
            return;
        }
        setTimeout(() => {
            console.log("now playing " + name);
            isLoadingNow = true;
            player1.play();
            performanceStats['playStartTime'] = Date.now();

            // back to cover
            $("#main-song-cover2").addClass("d-none");
            $("#main-song-cover").hide();
            $("#main-song-cover").removeClass("d-none");
            $("#main-song-cover").fadeIn("slow");

        }, 500);

    }
    
    
    // isPlaying = True;
}


// function playSongOnIOS(){
//     if(!isOnIOS()){
//         console.log("not on IOS");
//         // return;
//     }
//     let url = playURLs.urls[currentIdxInPlayList];
//     let videoURL = `https://youtubemusic.songlinhou.repl.co/video?url=${url}`;
//     let $iframe = $("#videoPlayerIFrame").contents();
//     $iframe.find("#videoPlayerSource").attr("src", videoURL)
//     let player = $iframe.find("#player")[0]
//     setTimeout(()=>{
//         player.load();
//         // $("#videoPlayerIFrame").click();
//     }, 1000);
// }

function playSongOnIOSEmbed(url){
    if(!isOnIOS()){
        // alert("not on IOS");
        console.log("not on IOS");
        return;
    }
    console.log("playSongOnIOSEmbed, url=",url);
    let code = url.split("v=")[1].split("&")[0];
    let embedURL = `https://www.youtube.com/embed/${code}`;
    // let embedURL = `https://www.youtube.com/watch?v=${code}&autoplay=1&mute=0&controls=0`;

    let $iframe = $("#videoPlayerIFrame").attr("src", embedURL)
    $("#videoPlayerIFrame")[0].contentWindow.location.reload();
}

function loadSongFromPlaylist(id, playImmediately=true){
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    let songData = playlistData[id];
    startPlaySong(songData['url'], songData['name'], songData['artist'], songData['image'], songData['desc'], songData['length'], playImmediately);
}

function playNextSongInPlaylist(playImmediately=true){
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    if (currentIdxInPlayList < 0 || currentIdxInPlayList > playlistData.length - 1){
        console.log("reset index to 0");
        currentIdxInPlayList = 0;
    }
    else{
        currentIdxInPlayList += 1;
        currentIdxInPlayList = currentIdxInPlayList % playlistData.length;
    }

    loadSongFromPlaylist(currentIdxInPlayList, playImmediately);

}

function playPrevSongInPlaylist(playImmediately=true){
    if (!playlistData){
        console.log("playlist_data is not available");
        return;
    }
    if (currentIdxInPlayList < 0 || currentIdxInPlayList > playlistData.length - 1){
        console.log("reset index to 0");
        currentIdxInPlayList = 0;
    }
    if (currentIdxInPlayList == 0){
        currentIdxInPlayList = playlistData.length - 1;
    } 
    else{
        currentIdxInPlayList -= 1;
        currentIdxInPlayList = currentIdxInPlayList % playlistData.length;
    }

    loadSongFromPlaylist(currentIdxInPlayList, playImmediately);

}

function isDropdownVisible(){
    return $('.dropdown-menu.show').length > 0;
}

function closeDropdown(){
    $('.dropdown-menu').removeClass('show');
}

async function obtainPlayList(){
    let playListItems = await requestMusicItemListData(playURLs);
    viewingPlaylistData = playListItems;
    generateSongHTMLInPlaylist(viewingPlaylistData);
    $('.song-click-area').off("click");
    $('.song-click-area').on("click",(e)=>{
        let dropdownVisible = isDropdownVisible();
        if(dropdownVisible){
            console.log("dismiss the dropdown");
            closeDropdown();
            e.preventDefault();
            return;
        }
        console.log("target=", $(e.target));
        let $idItem = $(e.target).parent().closest('.song-click-area'); 
        let idx = parseInt($idItem.attr("song-idx"));
        console.log(`click song ${idx} to play`);
        playlistData = viewingPlaylistData;
        currentIdxInPlayList = idx;
        loadSongFromPlaylist(currentIdxInPlayList, true);
    });
}

async function obtainLikedSongsPlayList(){
    let playListItems = await getAllLikedSongs();
    console.log("song meta from local likedsongs:", playListItems);
    let numLikedSongs = playListItems.length;
    if(numLikedSongs == 0){
        console.log('no liked song yet. add some? GUI modal here');
        $("#numberOfLikedSongs").html("empty");
        return;
    }
    $("#numberOfLikedSongs").html(`${numLikedSongs} songs available`);

    viewingPlaylistData = playListItems;
    generateSongHTMLInPlaylist(viewingPlaylistData);
    $('.song-click-area').off("click");
    $('.song-click-area').on("click",(e)=>{
        let dropdownVisible = isDropdownVisible();
        if(dropdownVisible){
            console.log("dismiss the dropdown");
            closeDropdown();
            e.preventDefault();
            return;
        }
        console.log("target=", $(e.target));
        let $idItem = $(e.target).parent().closest('.song-click-area'); 
        let idx = parseInt($idItem.attr("song-idx"));
        console.log(`click song ${idx} to play`);
        playlistData = viewingPlaylistData;
        currentIdxInPlayList = idx;
        loadSongFromPlaylist(currentIdxInPlayList, true);
    });
}


async function addSampleSongsToDB(){
    let playListItems = await getAllLikedSongs();
    if(playListItems.length > 0){
        console.log('already have some liked songs. skip...');
        return;
    }
    let sampleBulkData = await requestMusicItemListData(playURLs);

    for(let i=0; i < sampleBulkData.length; i++){
        const rec = sampleBulkData[i];
        rec['data'] = 0;
        rec['timestamp'] = Date.now();
    }
    await addBulkRecordsToLikedSongs(sampleBulkData);
}

async function addURLToLiked(url){
    let tempURL = {'urls': [url]};
    let sampleBulkData = await requestMusicItemListData(tempURL);
    let data = sampleBulkData[0];
    if (Object.keys(data).length > 0){
        data['data'] = 0;
        data['timestamp'] = Date.now();
        await addOneRecordToLikedSongs(data);
        await obtainLikedSongsPlayList();
        console.log("add to liked songs successfully");
        return true;
    }
    else{
        console.log("error in adding URL.");
        return false;
    }
}

function playViewingPlayList(){
    playlistData = viewingPlaylistData;
    console.log("playViewingPlayList", playlistData);
    currentIdxInPlayList = -1;
    playNextSongInPlaylist(true);
}

function onMusicLoadingComplete(){
    let timeElapsed = Math.floor( (Date.now() - performanceStats['playStartTime']) / 1000);
    console.log("music loading completed. Time used for loading: " + timeElapsed + " seconds.");
}

function timeCal() {
    console.log("timeCal is called");
    if(isLoadingNow){
        onMusicLoadingComplete();
        isLoadingNow = false;
    }
    var width = $("#timeline1").width();
    // var length = player1.duration;
    var length = current_song_length;
    var current_time = player1.currentTime;
    

    // calculate total length of value

    var totalLength = calculateTotalValue(length);
  //console.info(totalLength);
    $(".end-time").html(totalLength);

    // calculate current value time
    var currentTime = calculateCurrentValue(current_time);
    $(".start-time").html(currentTime);

    var progressbar = document.getElementById("seekObj1");
    progressbar.style.marginLeft = width * (player1.currentTime / player1.duration) + "px";
    var percent = player1.currentTime / player1.duration * 100;
    $("#mini-progress-bar").css("width", percent + "%");

    if (length > 0){
        let remainingTime = player1.currentTime - length;
        // console.log("remaining time:", remainingTime);
        if(remainingTime >= -1){
            if(loopPlayList){
                console.log("play next song");
                playNextSongInPlaylist(true);
            }
        }

    }
    

}

function calculateTotalValue(length) {
    var minutes = Math.floor(length / 60);
    var  seconds_int = length - minutes * 60;
    if(seconds_int < 10){
        seconds_int = "0"+seconds_int;
    }
    var seconds_str = seconds_int.toString();
    var  seconds = seconds_str.substr(0, 2);
    var time = minutes + ':' + seconds;
    return time;
}

function calculateCurrentValue(currentTime) {
    var current_hour = parseInt(currentTime / 3600) % 24,
        current_minute = parseInt(currentTime / 60) % 60,
        current_seconds_long = currentTime % 60,
        current_seconds = current_seconds_long.toFixed(),
        current_time = (current_minute < 10 ? "0" + current_minute : current_minute) + ":" + (current_seconds < 10 ? "0" + current_seconds : current_seconds);
    return current_time;
}

function ballSeek() {
     onplayhead = null;
     playerId = null;
     timeline = document.getElementById("timeline1");
     playhead = document.getElementById("seekObj1");
     timelineWidth = timeline.offsetWidth - playhead.offsetWidth;

    timeline.addEventListener("click", seek);
    playhead.addEventListener('mousedown', drag);
    window.addEventListener('mouseup', mouseUp);

}


function seek(event) {
    var player = document.getElementById("player2");
    player.currentTime = player.duration * clickPercent(event, timeline, timelineWidth);
}

function clickPercent(e, timeline, timelineWidth) {
    timeline = document.getElementById("timeline1");
    playhead = document.getElementById("seekObj1");
    timelineWidth = timeline.offsetWidth - playhead.offsetWidth;
    return (event.clientX - getPosition(timeline)) / timelineWidth;
}

function getPosition(el) {
    return el.getBoundingClientRect().left;
}

function drag(e) {
    console.log("drag...")
    player1.removeEventListener("timeupdate", timeCal);
    onplayhead = $(this).attr("id");
    // playerId = $(this).parents("li").find("audio").attr("id");
    playerId = $("#player2").attr("id");
    console.log("playerId=", playerId)
    var player = document.getElementById(playerId);
    window.addEventListener('mousemove', dragFunc);
    player.removeEventListener('timeupdate', timeUpdate);
}


function dragFunc(e) {
    var player = document.getElementById(onplayhead);
    var newMargLeft = e.clientX - getPosition(timeline);

    if (newMargLeft >= 0 && newMargLeft <= timelineWidth) {
        playhead.style.marginLeft = newMargLeft + "px";
    }
    if (newMargLeft < 0) {
        playhead.style.marginLeft = "0px";
    }
    if (newMargLeft > timelineWidth) {
        playhead.style.marginLeft = timelineWidth + "px";
    }
}

function mouseUp(e) {
    if (onplayhead != null) {
        var player = document.getElementById(playerId);
        window.removeEventListener('mousemove', dragFunc);
        player.currentTime = player.duration * clickPercent(e, timeline, timelineWidth);
        player1.addEventListener("timeupdate", timeCal);
        player.addEventListener('timeupdate', timeUpdate);
    }
    onplayhead = null;
}

function timeUpdate() {
    var player2 = document.getElementById("seekObj1");
    var player = document.getElementById("player2");
    var playPercent = timelineWidth * (player.currentTime / player.duration);
    player2.style.marginLeft = playPercent + "px";
    // If song is over
    var playBtn = $(".main-play-btn");
    console.log("player.duration - player.currentTime=", player.duration - player.currentTime)
    if (player.currentTime == player.duration) {
        console.log("song is over")
        player.pause();
        $(".end-time").html("--:--");
        $(".start-time").html("00:00");
        isPlaying = false;
        $(".play-pause").empty().text("PLAY");
        console.log("playBtn=", playBtn);
        playBtn.removeClass("fa-circle-pause");
        playBtn.addClass("fa-circle-play");
    }

}

        </script>

</body>
</html>